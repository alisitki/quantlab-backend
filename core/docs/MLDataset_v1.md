# MLDataset v1 Contract

**Version**: 1.0.1
**Status**: DRAFT (Baseline for XGBoost Binary Classification)

## 1. Goal
Define a deterministic, single-symbol, single-day dataset for model training and evaluation.

## 2. Granularity
- **Type**: Event-level (BBO Ticks)
- **Source**: `exchange=binance/stream=bbo/symbol=btcusdt/`

## 3. Input Schema (Curated Source)
Expected columns from the curated Parquet files:

| Column | Type | Description |
|--------|------|-------------|
| `ts_event` | long | Event timestamp in milliseconds (Primary Sort Key) |
| `bid_price` | double | Best bid price |
| `ask_price` | double | Best ask price |
| `bid_qty` | double | Best bid quantity |
| `ask_qty` | double | Best ask quantity |
| `seq` | long | Sequence number (Tie-breaker) |

## 4. Output Feature Schema
The generated dataset contains:
- `ts_event`: Event timestamp (Join Key)
- `f_mid`, `f_spread_bps`, `f_imbalance`, `f_microprice`: Real-time features.
- `f_ret_1s`, `f_ret_5s`, `f_ret_10s`, `f_vol_10s`: Time-window features.
- `label_dir_10s`: Target label (1/0).

## 5. Determinism & Sorting Rules
To ensure 100% reproducible training datasets:

1. **Strict Sorting**: Data must be sorted by `ts_event ASC, seq ASC`.
2. **Missing Tie-breaker**: In rare cases where `seq` is missing or duplicate for the same `ts_event`, a **stable sorting algorithm** must be used (e.g., preserving original Parquet row order) or a fallback hash of the entire row. 
   - *Requirement*: Under no circumstances should the row order change between two runs of the same dataset generation.
3. **Floating Point**: Dataset generation should avoid operations that vary by CPU architecture (e.g., standardizing rounding for BPS).
4. **Hashing**: Dataset Config Hash includes: `feature_version`, `label_horizon`, `symbol`, `date`, `columns`.

## 6. Usage (Scheduler Integration)
The `JobSpec` generated by the Scheduler points to these locations:

```json
{
  "dataset": {
    "featuresetVersion": "v1",
    "labelHorizonSec": 10,
    "inputPath": "s3://quantlab-compact/curated/exchange=binance/stream=bbo/symbol=btcusdt/date=20251229/",
    "featurePath": "s3://quantlab-compact/features/featureset=v1/exchange=binance/stream=bbo/symbol=btcusdt/date=20251229/data.parquet"
  }
}
```
